package server.controller;

import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.Date;

import com.google.gson.Gson;
import com.google.gson.JsonArray;
import com.google.gson.JsonObject;

import entitys.DeterminingRateRequests;
import entitys.Fuel;
import entitys.Message;
import entitys.enums.MessageType;
import ocsf.server.AbstractServer;
import ocsf.server.ConnectionToClient;
import server.dbLogic.DBConnector;

public class ServerController extends AbstractServer {

	public static DBConnector dbConnector;

	public ServerController(int port) {
		super(port);
		dbConnector = new DBConnector();
	}

	@Override
	protected void handleMessageFromClient(Object msg, ConnectionToClient client) {

		try {
			Message message = (Message) msg;
			Message messageFromServer = null;
			switch (message.getMessageType()) {
			case CHECK_LOGIN:
			case CHECK_IF_USER_EXIST:
			case GET_USER_DETAILS:
			case LOGOUT:
				messageFromServer = handleUserMessage(message);
				break;
			case GET_FUEL_BY_TYPE:
			case GET_FUEL_TYPES:
			case GET_FUEL_COMPANIES_NAMES:
			case UPDATE_FUEL:
			case SEND_RATE_REQUEST:
			case GET_RATES_REQUESTS:
			case UPDATE_DECISION:
			case GET_FUEL_INVENTORY_PER_STATION:
				messageFromServer = handleFuelMessage(message);
				break;
			case GET_PURCHASE_MODELS:
				messageFromServer = handlePurchaseModelsMessage(message);
				break;
			case SUBMIT_HOME_HEATING_FUEL_ORDER:
			case GET_HOME_HEATING_FUEL_ORDERS:	
			case GET_ORDERS_BY_STATIONID:
				messageFromServer = handleOrderMessage(message);
				break;
			case CHECK_IF_CUSTOMER_EXIST:
			case GET_SUBSCRIBE_TYPES:
			case CHECK_IF_VEHICLE_EXIST:
			case REGISTER_CUSTOMER:
			case GET_CUSTOMER_DETAILS_BY_ID:
			case UPDATE_CUSTOMER_DETAILS:
	
				messageFromServer = handleCustomerMessage(message);
				break;
			case GET_SALE_TEMPLATES:
			case UPDATE_RUNNING_SALE:
			case GET_SALE_NAMES:
				messageFromServer = handleSaleTemplateMessage(message);
				break;
			default:
//				messageFromServer = new Message(MessageType.ERROR_TYPE_IS_UNSET, null);
				break;
			}

			client.sendToClient(messageFromServer);
		} catch (IOException e) {
			e.printStackTrace();
		}
	}

	private Message handleSaleTemplateMessage(Message msg) {
		Message messageFromServer = null;
		JsonObject requestJson = msg.getMessageAsJsonObject();
		JsonObject responseJson = new JsonObject();
		switch (msg.getMessageType()) {
		case GET_SALE_TEMPLATES: 
				JsonArray saleTemplates = dbConnector.saleDBLOgic.getSaleTemplates();
				responseJson.add("saleTemplates", saleTemplates);
			break;
		case UPDATE_RUNNING_SALE:{
				String saleName = requestJson.get("saleName").getAsString();
				int isRunning = requestJson.get("isRunning").getAsInt();
				dbConnector.saleDBLOgic.updateRunningSale(saleName, isRunning);
		}	break;
		case GET_SALE_NAMES:{
			JsonArray saleName = dbConnector.saleDBLOgic.getSaleNames();
			responseJson.add("saleNames", saleName);
		}	break;
		default:
			break;
		}
		messageFromServer = new Message(MessageType.SERVER_RESPONSE, responseJson.toString());
		return messageFromServer;
	}

	private Message handleOrderMessage(Message msg) {
		Message messageFromServer = null;
		JsonObject requestJson = msg.getMessageAsJsonObject();
		JsonObject responseJson = new JsonObject();
		switch (msg.getMessageType()) {
		case SUBMIT_HOME_HEATING_FUEL_ORDER: {
			dbConnector.orderDBLogic.insertHomeHeatingFuelOrder(requestJson);
		}
			break;
		case GET_HOME_HEATING_FUEL_ORDERS: {
			JsonArray HHFOrders = dbConnector.orderDBLogic.GetHomeHeatingFuelOrder();
			responseJson.add("HHFOrders", HHFOrders);	
		}break;
		case GET_ORDERS_BY_STATIONID: {
			String stationID = requestJson.get("stationID").getAsString();
			String fuelType = requestJson.get("fuelType").getAsString();
			JsonArray orders;
			
			// for quarterly report
			if (fuelType.equals("")) {
				orders = dbConnector.orderDBLogic
						.getHomeHeatingFuelOrdersByStationID(requestJson);
				responseJson.add("homeHeatingFuelOrders", orders);
				orders = dbConnector.orderDBLogic
						.getFastFuelOrdersByStationID(stationID);
				responseJson.add("fastFuelOrders", orders);
			} else { // for sale report
				if (fuelType.equals("Home heating fuel")) {
					orders = dbConnector.orderDBLogic
							.getHomeHeatingFuelOrdersByStationID(requestJson);
				} else {
					orders = dbConnector.orderDBLogic
							.getFastFuelOrdersByStationID(stationID);
				}
				responseJson.add("orders", orders);
			}
		}
			break;
		default:
			break;
		}
		messageFromServer = new Message(MessageType.SERVER_RESPONSE, responseJson.toString());
		return messageFromServer;
	}

	private Message handleFuelMessage(Message msg) {
		Message messageFromServer = null;
		JsonObject requestJson = msg.getMessageAsJsonObject();
		JsonObject responseJson = new JsonObject();
		switch (msg.getMessageType()) {
		case GET_FUEL_COMPANIES_NAMES: {
			JsonArray types = dbConnector.fuelDBLogic.getFuelCompanyNames();
			responseJson.add("fuelCompanies", types);
			messageFromServer = new Message(MessageType.SERVER_RESPONSE, responseJson.toString());
		}
			break;
		case GET_FUEL_BY_TYPE: {
			String fuelType = requestJson.get("fuelType").getAsString();
			Fuel fuel = dbConnector.fuelDBLogic.getFuelObjectByType(fuelType);
			String response = new Gson().toJson(fuel);
			messageFromServer = new Message(MessageType.SERVER_RESPONSE, response);
		}
			break;
		case GET_FUEL_TYPES: {
			JsonArray fuelTypes = dbConnector.fuelDBLogic.getFuelTypes();
			responseJson.add("fuelTypes", fuelTypes);
			messageFromServer = new Message(MessageType.SERVER_RESPONSE, responseJson.toString());
		}
			break;
		case UPDATE_FUEL: {
			System.out.println("UPDATE_FULE !!");
			String fuelType = requestJson.get("fuelType").getAsString();
			String newPrice = requestJson.get("pricePerLitter").getAsString();
			Fuel fuel = dbConnector.fuelDBLogic.getFuelObjectByType(fuelType);
			dbConnector.fuelDBLogic.updateFuel(fuel, newPrice);
			messageFromServer = new Message(MessageType.SERVER_RESPONSE, "");
		}
			break;
		case GET_FUEL_INVENTORY_PER_STATION: {
			JsonArray fuelInventory = dbConnector.fuelDBLogic
					.getFuelInventoryPerStation(requestJson.get("stationID")
							.getAsString());
			responseJson.add("fuelInventory", fuelInventory);
			messageFromServer = new Message(MessageType.SERVER_RESPONSE,
					responseJson.toString());
		}break;
		case SEND_RATE_REQUEST: {
			String fuelType = requestJson.get("fuelType").getAsString();
			String newPrice = requestJson.get("pricePerLitter").getAsString();
			Fuel fuel = dbConnector.fuelDBLogic.getFuelObjectByType(fuelType);
			
			String createTime;
			SimpleDateFormat formatter= new SimpleDateFormat("dd-MM-yyyy ' ' HH:mm ");
			Date date = new Date(System.currentTimeMillis());
			createTime=formatter.format(date);
			System.out.println(createTime);
			DeterminingRateRequests detRequest = new DeterminingRateRequests(-1 ,
					 fuel.getPricePerLitter(), Float.parseFloat(newPrice),
			 fuelType ,createTime);
			dbConnector.fuelDBLogic.SendRateRequest(detRequest, newPrice);
			messageFromServer = new Message(MessageType.SERVER_RESPONSE, "");

		}
		break;
		case GET_RATES_REQUESTS:{
			JsonArray RateRequests = dbConnector.fuelDBLogic.getRateRequests();
			responseJson.add("RateRequests", RateRequests);
			
		}
		break;
		case UPDATE_DECISION:{
			String decline = requestJson.get("reasonOfDecline").getAsString();
			boolean decision=requestJson.get("decision").getAsBoolean();
			String ID=requestJson.get("requestID").getAsString();
			dbConnector.fuelDBLogic.UpdateDecline(decline,decision,ID);
			messageFromServer = new Message(MessageType.SERVER_RESPONSE, "");
		}
		break;
		default:
			break;
		}
		return messageFromServer;
	}

	private Message handlePurchaseModelsMessage(Message msg) {
		Message messageFromServer = null;
		JsonObject requestJson = msg.getMessageAsJsonObject();
		JsonObject responseJson = new JsonObject();
		switch (msg.getMessageType()) {
		case GET_PURCHASE_MODELS: {
			JsonArray types = dbConnector.purchaseModelDBLogic.getPurchaseModelsTypes();
			responseJson.add("purchaseModelTypes", types);
		}
			break;
		default:
			break;
		}
		messageFromServer = new Message(MessageType.SERVER_RESPONSE, responseJson.toString());
		return messageFromServer;
	}

	private Message handleCustomerMessage(Message msg) {
		Message messageFromServer = null;
		JsonObject requestJson = msg.getMessageAsJsonObject();
		JsonObject responseJson = new JsonObject();
		switch (msg.getMessageType()) {
		case CHECK_IF_CUSTOMER_EXIST:
			boolean isExist = dbConnector.customerDBLogic.checkIfCustomerExist(requestJson.get("customerID").getAsString());
			responseJson.addProperty("isExist", isExist);
			break;
		case GET_SUBSCRIBE_TYPES:
			JsonArray types = dbConnector.customerDBLogic.getSubscribeTypes();
			responseJson.add("subscribeTypes", types);
			break;
		case CHECK_IF_VEHICLE_EXIST:
			boolean vehicleIsExist = dbConnector.customerDBLogic.checkIfVehicleExist(requestJson);
			responseJson.addProperty("isExist", vehicleIsExist);
			break;
		case REGISTER_CUSTOMER:
				register(requestJson);
			break;
		case GET_CUSTOMER_DETAILS_BY_ID:
			String customerID = requestJson.get("customerID").getAsString();
			responseJson = dbConnector.customerDBLogic.getCustomerDetails(customerID);
			break;
		case UPDATE_CUSTOMER_DETAILS://or
			responseJson = dbConnector.customerDBLogic.updateCustomerDetails(requestJson);
			break;
		default:
			break;
		}
		messageFromServer = new Message(MessageType.SERVER_RESPONSE, responseJson.toString());
		return messageFromServer;

	}

	public void register(JsonObject requestJson) {
		dbConnector.userDBController.addUser(requestJson);
		dbConnector.customerDBLogic.addCustomer(requestJson);
		if(requestJson.get("creditCard") != null) {
			JsonObject creditCard = requestJson.get("creditCard").getAsJsonObject();
			dbConnector.customerDBLogic.addCreditCard(creditCard);
		}
		JsonArray vehicles = requestJson.get("vehicles").getAsJsonArray(); 
		for(int i = 0; i < vehicles.size(); i++) {
			JsonObject vehicle = vehicles.get(i).getAsJsonObject();
			dbConnector.customerDBLogic.addVehicle(vehicle);
		}
		
		JsonArray fuelCompanies = requestJson.get("purchaseModel").getAsJsonObject().get("fuelCompany").getAsJsonArray();
		dbConnector.customerDBLogic.addFuelCompanies(requestJson.get("customerID").getAsString(), fuelCompanies);
	}
	
	public Message handleUserMessage(Message msg) {
		Message messageFromServer = null;
		JsonObject requestJson = msg.getMessageAsJsonObject();
		JsonObject responseJson = new JsonObject();
		switch (msg.getMessageType()) {
		case CHECK_LOGIN: {
			String userName = requestJson.get("userName").getAsString();
			String password = requestJson.get("password").getAsString();
			
			responseJson = dbConnector.userDBController.checkLogin(userName,password);
		}
			break;
		case CHECK_IF_USER_EXIST: 
			boolean isExist = dbConnector.userDBController
					.checkIfUsernameExist(requestJson.get("userName").getAsString());
			responseJson.addProperty("isExist", isExist);
			break;
		
		case GET_USER_DETAILS:
			responseJson = dbConnector.userDBController.getUserDetails(requestJson);
			String employeeRole = dbConnector.employeeDBLogic.getEmployeeRoleByUsername(requestJson.get("userName").getAsString());
			responseJson.addProperty("employeeRole", employeeRole);
			break;
		case LOGOUT:
			dbConnector.userDBController.updateLoginFlag(requestJson.get("userName").getAsString(), 0);
			break;
		default:
			break;
		}
		messageFromServer = new Message(MessageType.SERVER_RESPONSE, responseJson.toString());
		return messageFromServer;
	}

	protected void serverStarted() {
		System.out.println("Server listening for connections on port " + getPort());
	}
}
